---
import Layout from '../../layouts/Layout.astro';
import Challenge from '../../components/Challenges.svelte';
import Header from '../../components/Header.svelte';
import DatabaseActions from '../../lib/actions';
import { normalWrapper } from '../../lib/backend';
import { auth } from '../../lib/lucia';
import { DUMMY_SESSION } from '../../lib/helpers';

const { uuid } = Astro.params;

let session = DUMMY_SESSION;

if (!import.meta.env.DEV) {
    session = await Astro.locals.auth.validate();
    if (!session) return Astro.redirect('/login');
    if (session.user.isBlocked) {
        await auth.invalidateAllUserSessions(session.user.userId);
        return Astro.redirect('/login');
    }
    if (!session.user.emailVerified) {
        return Astro.redirect('/verify/email');
    }
}

// check if we access a non-existing challenge
const ACTION = new DatabaseActions();
let exists = await ACTION.checkEventExist(uuid || '');
if (!exists) {
    // early exit to 404
    return Astro.redirect('/404');
}

if (Astro.request.method === 'POST') {
    return await normalWrapper(Astro.request);
}
---

<Layout title="CTF-Citadel">
    <Header
        username={session.user.username}
        interactive={true}
        admin={session.user.user_role == 'admin' ? true : false}
        client:visible
    />
    <div transition:animate="slide">
        <Challenge uuid={uuid} team={session.user.user_team_id} client:visible />
    </div>
</Layout>
