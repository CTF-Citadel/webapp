---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.svelte';
import { validateEmailVerificationToken } from "../../lib/lucia-db";
import { lucia } from '../../lib/lucia';

const { id } = Astro.params;

try {
	const USER_ID = await validateEmailVerificationToken(id || "");
	if (!USER_ID) {
		return new Response("Invalid or Expired Token!", {
			status: 401
		});
	}
	await lucia.invalidateUserSessions(USER_ID);
	// ###
	// @TODO: Update User Attributes here
	// ###
	return Astro.redirect('/login')
} catch {
	return new Response("Invalid Email Verification Link!", {
		status: 400
	});
}
---

<Layout title="Email Verify Check">
    <Header client:visible />
</Layout>
